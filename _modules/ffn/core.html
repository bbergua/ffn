
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ffn.core &#8212; ffn 0.3.6 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/klink.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
         
        <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
        
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono:400,500,700' rel='stylesheet' type='text/css'>
    
  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ffn.core</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">sklearn.cluster</span>
<span class="kn">import</span> <span class="nn">sklearn.covariance</span>
<span class="kn">import</span> <span class="nn">sklearn.manifold</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>  <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">pandas.core.base</span> <span class="kn">import</span> <span class="n">PandasObject</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">resample</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">fmtn</span><span class="p">,</span> <span class="n">fmtp</span><span class="p">,</span> <span class="n">fmtpn</span><span class="p">,</span> <span class="n">get_freq_name</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Set2&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="c1"># module level variable, can be different for non traditional markets (eg. crypto - 360)</span>
<span class="n">TRADING_DAYS_PER_YEAR</span> <span class="o">=</span> <span class="mi">252</span>


<div class="viewcode-block" id="PerformanceStats"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats">[docs]</a><span class="k">class</span> <span class="nc">PerformanceStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PerformanceStats is a convenience class used for the performance</span>
<span class="sd">    evaluation of a price series. It contains various helper functions</span>
<span class="sd">    to help with plotting and contains a large amount of descriptive</span>
<span class="sd">    statistics.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series): A price series.</span>
<span class="sd">        * rf (float, Series): `Risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_ used in various calculation. Should be</span>
<span class="sd">            expressed as a yearly (annualized) return if it is a float. Otherwise</span>
<span class="sd">            rf should be a price series.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        * name (str): Name, derived from price series name</span>
<span class="sd">        * return_table (DataFrame): A table of monthly returns with</span>
<span class="sd">            YTD figures as well.</span>
<span class="sd">        * lookback_returns (Series): Returns for different</span>
<span class="sd">            lookback periods (1m, 3m, 6m, ytd...)</span>
<span class="sd">        * stats (Series): A series that contains all the stats</span>
<span class="sd">        * annualization_factor (float): `Annualization factor` used in various calculations; aka `nperiods`, `252`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">annualization_factor</span><span class="o">=</span><span class="n">TRADING_DAYS_PER_YEAR</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PerformanceStats</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span> <span class="o">=</span> <span class="n">annualization_factor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span>

<div class="viewcode-block" id="PerformanceStats.set_riskfree_rate"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.set_riskfree_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_riskfree_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set annual risk-free rate property and calculate properly annualized</span>
<span class="sd">        monthly and daily rates. Then performance stats are recalculated.</span>
<span class="sd">        Affects only this instance of the PerformanceStats.</span>

<span class="sd">        Args:</span>
<span class="sd">            * rf (float): Annual `risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">rf</span>

        <span class="c1"># Note, that we recalculate everything.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># calc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># update derived structure</span>
        <span class="c1"># return table as dataframe for easier manipulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># name columns</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
                <span class="s2">&quot;YTD&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lookback_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mtd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">three_month</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">six_month</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ytd</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one_year</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">three_year</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">five_year</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ten_year</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cagr</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;mtd&quot;</span><span class="p">,</span> <span class="s2">&quot;3m&quot;</span><span class="p">,</span> <span class="s2">&quot;6m&quot;</span><span class="p">,</span> <span class="s2">&quot;ytd&quot;</span><span class="p">,</span> <span class="s2">&quot;1y&quot;</span><span class="p">,</span> <span class="s2">&quot;3y&quot;</span><span class="p">,</span> <span class="s2">&quot;5y&quot;</span><span class="p">,</span> <span class="s2">&quot;10y&quot;</span><span class="p">,</span> <span class="s2">&quot;incep&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback_returns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_stats_series</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_sortino</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worst_day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cagr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_details</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_skew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_kurt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_drawdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_drawdown_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_sortino</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worst_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">three_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_month_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_up_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_down_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_skew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_kurt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">six_month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ytd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_sortino</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worst_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">three_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win_year_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twelve_month_win_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_skew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_kurt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">five_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ten_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calmar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># end default values</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># save daily prices for future use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_prices</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="c1"># resample(&#39;D&#39;) imputes na values for any day that didn&#39;t have a price</span>
        <span class="c1">#  .dropna() removes the na values but also implies that the original</span>
        <span class="c1">#  price series didn&#39;t have any na values</span>
        <span class="c1">#  if months or years are missing then we will need .dropna() too</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">daily_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_prices</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="c1"># M = month end frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_prices</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>  <span class="c1"># .dropna()</span>
        <span class="c1"># A == year end frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yearly_prices</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>  <span class="c1"># .dropna()</span>

        <span class="c1"># let&#39;s save some typing</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_prices</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthly_prices</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearly_prices</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mtd</span> <span class="o">=</span> <span class="n">calc_mtd</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ytd</span> <span class="o">=</span> <span class="n">calc_ytd</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">yp</span><span class="p">)</span>

        <span class="c1"># stats using daily data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_returns</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">to_log_returns</span><span class="p">()</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">returns</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Will calculate daily figures only if the input data has at least daily frequency or higher (e.g hourly)</span>
        <span class="c1"># Rather &lt; 2 days than &lt;= 1 days in case of data taken at different hours of the days</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;2 days&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_mean</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">daily_sharpe</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">calc_sharpe</span><span class="p">(</span>
                    <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">daily_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span>
                <span class="p">)</span>
            <span class="c1"># rf is a price series</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_rf_daily_price_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">daily_sharpe</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">calc_sharpe</span><span class="p">(</span>
                    <span class="n">rf</span><span class="o">=</span><span class="n">_rf_daily_price_returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">daily_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">_rf_daily_price_returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annualization_factor</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">best_day</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worst_day</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_return</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cagr</span> <span class="o">=</span> <span class="n">calc_cagr</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cagr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">to_drawdown_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_details</span> <span class="o">=</span> <span class="n">drawdown_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawdown</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_drawdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_details</span><span class="p">[</span><span class="s2">&quot;drawdown&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_drawdown_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawdown_details</span><span class="p">[</span><span class="s2">&quot;Length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calmar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cagr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;2 days&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daily_skew</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>

            <span class="c1"># if all zero/nan kurt fails division by zero</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">daily_kurt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>

        <span class="c1"># stats using monthly data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monthly_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthly_prices</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">monthly_returns</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Will calculate monthly figures only if the input data has at least monthly frequency or higher (e.g daily)</span>
        <span class="c1"># Rather &lt; 32 days than &lt;= 31 days in case of data taken at different hours of the days</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;32 days&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monthly_mean</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">12</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monthly_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthly_sharpe</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">calc_sharpe</span><span class="p">(</span><span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthly_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="c1"># rf is a price series</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_rf_monthly_price_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthly_sharpe</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">calc_sharpe</span><span class="p">(</span>
                    <span class="n">rf</span><span class="o">=</span><span class="n">_rf_monthly_price_returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">12</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthly_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span><span class="p">(</span>
                    <span class="n">mr</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">_rf_monthly_price_returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">12</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_month</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worst_month</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="c1"># -1 here to account for first return that will be nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_month_perc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">[</span><span class="n">mr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_up_month</span> <span class="o">=</span> <span class="n">mr</span><span class="p">[</span><span class="n">mr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_down_month</span> <span class="o">=</span> <span class="n">mr</span><span class="p">[</span><span class="n">mr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="c1"># return_table</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mr</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">3</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">4</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">5</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">6</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">7</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">8</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">9</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">10</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">11</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">12</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mr</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">[</span><span class="n">idx</span><span class="o">.</span><span class="n">year</span><span class="p">][</span><span class="n">idx</span><span class="o">.</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">mr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># add first month</span>
            <span class="n">fidx</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">[</span><span class="n">fidx</span><span class="o">.</span><span class="n">year</span><span class="p">][</span><span class="n">fidx</span><span class="o">.</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">[</span><span class="n">fidx</span><span class="o">.</span><span class="n">year</span><span class="p">][</span><span class="n">fidx</span><span class="o">.</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># calculate the YTD values</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">arr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;93 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">denom</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[:</span> <span class="n">dp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">three_month</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;32 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">monthly_skew</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>

            <span class="c1"># if all zero/nan kurt fails division by zero</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">[(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monthly_kurt</span> <span class="o">=</span> <span class="n">mr</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;185 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">denom</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[:</span> <span class="n">dp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">)]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">six_month</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Will calculate yearly figures only if the input data has at least yearly frequency or higher (e.g monthly)</span>
        <span class="c1"># Rather &lt; 367 days than &lt;= 366 days in case of data taken at different hours of the days</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;367 days&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearly_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearly_prices</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span>
            <span class="n">yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearly_returns</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">denom</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[:</span> <span class="n">dp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one_year</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">yearly_mean</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">yearly_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># if type(self.rf) is float:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearly_vol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">yearly_sharpe</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">calc_sharpe</span><span class="p">(</span><span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yearly_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span><span class="p">(</span><span class="n">yr</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># rf is a price series</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_rf_yearly_price_returns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">yearly_vol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">yearly_sharpe</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">calc_sharpe</span><span class="p">(</span>
                        <span class="n">rf</span><span class="o">=</span><span class="n">_rf_yearly_price_returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">1</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yearly_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span><span class="p">(</span>
                    <span class="n">yr</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">_rf_yearly_price_returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">best_year</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worst_year</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="c1"># -1 here to account for first return that will be nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">win_year_perc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">[</span><span class="n">yr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># need at least 1 year of monthly returns</span>
            <span class="k">if</span> <span class="n">mr</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">:</span>
                <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">win</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)):</span>
                    <span class="n">tot</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">mp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">mp</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">11</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">win</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">twelve_month_win_perc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">win</span><span class="p">)</span> <span class="o">/</span> <span class="n">tot</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1097 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># annualize stat for over 1 year</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">three_year</span> <span class="o">=</span> <span class="n">calc_cagr</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">:])</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;367 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">yearly_skew</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>

            <span class="c1"># if all zero/nan kurt fails division by zero</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">[(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">yr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yearly_kurt</span> <span class="o">=</span> <span class="n">yr</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1828 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">five_year</span> <span class="o">=</span> <span class="n">calc_cagr</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="p">:])</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;3654 days&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ten_year</span> <span class="o">=</span> <span class="n">calc_cagr</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="n">dp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">:])</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rf&quot;</span><span class="p">,</span> <span class="s2">&quot;Risk-free rate&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;total_return&quot;</span><span class="p">,</span> <span class="s2">&quot;Total Return&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;cagr&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;max_drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;Max Drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;calmar&quot;</span><span class="p">,</span> <span class="s2">&quot;Calmar Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;mtd&quot;</span><span class="p">,</span> <span class="s2">&quot;MTD&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;three_month&quot;</span><span class="p">,</span> <span class="s2">&quot;3m&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;six_month&quot;</span><span class="p">,</span> <span class="s2">&quot;6m&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ytd&quot;</span><span class="p">,</span> <span class="s2">&quot;YTD&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;one_year&quot;</span><span class="p">,</span> <span class="s2">&quot;1Y&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;three_year&quot;</span><span class="p">,</span> <span class="s2">&quot;3Y (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;five_year&quot;</span><span class="p">,</span> <span class="s2">&quot;5Y (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ten_year&quot;</span><span class="p">,</span> <span class="s2">&quot;10Y (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;incep&quot;</span><span class="p">,</span> <span class="s2">&quot;Since Incep. (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Mean (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_vol&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Vol (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_skew&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Skew&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;best_day&quot;</span><span class="p">,</span> <span class="s2">&quot;Best Day&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;worst_day&quot;</span><span class="p">,</span> <span class="s2">&quot;Worst Day&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Mean (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_vol&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Vol (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_skew&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Skew&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;best_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Best Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;worst_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Worst Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Mean&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_vol&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Vol&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_skew&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Skew&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;best_year&quot;</span><span class="p">,</span> <span class="s2">&quot;Best Year&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;worst_year&quot;</span><span class="p">,</span> <span class="s2">&quot;Worst Year&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_drawdown_days&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Drawdown Days&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_up_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Up Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_down_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Down Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;win_year_perc&quot;</span><span class="p">,</span> <span class="s2">&quot;Win Year %&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;twelve_month_win_perc&quot;</span><span class="p">,</span> <span class="s2">&quot;Win 12m %&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">stats</span>

<div class="viewcode-block" id="PerformanceStats.set_date_range"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.set_date_range">[docs]</a>    <span class="k">def</span> <span class="nf">set_date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update date range of stats, charts, etc. If None then</span>
<span class="sd">        the original date is used. So to reset to the original</span>
<span class="sd">        range, just call with no args.</span>

<span class="sd">        Args:</span>
<span class="sd">            * start (date): start date</span>
<span class="sd">            * end (end): end date</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end</span> <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span></div>

<div class="viewcode-block" id="PerformanceStats.display"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays an overview containing descriptive stats for the Series</span>
<span class="sd">        provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stats for </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Annual risk-free rate considered: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Summary:&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_return</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_sharpe</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cagr</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Total Return&quot;</span><span class="p">,</span> <span class="s2">&quot;Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR&quot;</span><span class="p">,</span> <span class="s2">&quot;Max Drawdown&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Annualized Returns:&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtd</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">three_month</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">six_month</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ytd</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one_year</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">three_year</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">five_year</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ten_year</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incep</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">tabulate</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mtd&quot;</span><span class="p">,</span> <span class="s2">&quot;3m&quot;</span><span class="p">,</span> <span class="s2">&quot;6m&quot;</span><span class="p">,</span> <span class="s2">&quot;ytd&quot;</span><span class="p">,</span> <span class="s2">&quot;1y&quot;</span><span class="p">,</span> <span class="s2">&quot;3y&quot;</span><span class="p">,</span> <span class="s2">&quot;5y&quot;</span><span class="p">,</span> <span class="s2">&quot;10y&quot;</span><span class="p">,</span> <span class="s2">&quot;incep.&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Periodic:&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;sharpe&quot;</span><span class="p">,</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_sharpe</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monthly_sharpe</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearly_sharpe</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_mean</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monthly_mean</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearly_mean</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s2">&quot;vol&quot;</span><span class="p">,</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_vol</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monthly_vol</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearly_vol</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s2">&quot;skew&quot;</span><span class="p">,</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_skew</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monthly_skew</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearly_skew</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s2">&quot;kurt&quot;</span><span class="p">,</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daily_kurt</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monthly_kurt</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yearly_kurt</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_day</span><span class="p">),</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_month</span><span class="p">),</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">best_year</span><span class="p">)],</span>
            <span class="p">[</span>
                <span class="s2">&quot;worst&quot;</span><span class="p">,</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worst_day</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worst_month</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worst_year</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;daily&quot;</span><span class="p">,</span> <span class="s2">&quot;monthly&quot;</span><span class="p">,</span> <span class="s2">&quot;yearly&quot;</span><span class="p">]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Drawdowns:&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">),</span>
                <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_drawdown</span><span class="p">),</span>
                <span class="n">fmtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_drawdown_days</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="s2">&quot;# days&quot;</span><span class="p">]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Misc:&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;avg. up month&quot;</span><span class="p">,</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_up_month</span><span class="p">)],</span>
            <span class="p">[</span><span class="s2">&quot;avg. down month&quot;</span><span class="p">,</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_down_month</span><span class="p">)],</span>
            <span class="p">[</span><span class="s2">&quot;up year %&quot;</span><span class="p">,</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">win_year_perc</span><span class="p">)],</span>
            <span class="p">[</span><span class="s2">&quot;12m up %&quot;</span><span class="p">,</span> <span class="n">fmtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">twelve_month_win_perc</span><span class="p">)],</span>
        <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">))</span></div>

<div class="viewcode-block" id="PerformanceStats.display_monthly_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.display_monthly_returns">[docs]</a>    <span class="k">def</span> <span class="nf">display_monthly_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display a table containing monthly returns and ytd returns</span>
<span class="sd">        for every year in range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;Year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
                <span class="s2">&quot;YTD&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmtpn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PerformanceStats.display_lookback_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.display_lookback_returns">[docs]</a>    <span class="k">def</span> <span class="nf">display_lookback_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays the current lookback returns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback_returns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:,.2%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_default_plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">get_freq_name</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">kind</span><span class="p">)</span>

<div class="viewcode-block" id="PerformanceStats.plot"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for plotting the series.</span>

<span class="sd">        Args:</span>
<span class="sd">            * freq (str): Data frequency used for display purposes.</span>
<span class="sd">                Refer to pandas docs for valid freq strings.</span>
<span class="sd">            * figsize ((x,y)): figure size</span>
<span class="sd">            * title (str): Title if default not appropriate</span>
<span class="sd">            * logy (bool): log-scale for y axis</span>
<span class="sd">            * kwargs: passed to pandas&#39; plot method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_plot_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;Price Series&quot;</span><span class="p">)</span>

        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_series</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ser</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="n">logy</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PerformanceStats.plot_histogram"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.plot_histogram">[docs]</a>    <span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots a histogram of returns given a return frequency.</span>

<span class="sd">        Args:</span>
<span class="sd">            * freq (str): Data frequency used for display purposes.</span>
<span class="sd">                This will dictate the type of returns</span>
<span class="sd">                (daily returns, monthly, ...)</span>
<span class="sd">                Refer to pandas docs for valid period strings.</span>
<span class="sd">            * figsize ((x,y)): figure size</span>
<span class="sd">            * title (str): Title if default not appropriate</span>
<span class="sd">            * bins (int): number of bins for the histogram</span>
<span class="sd">            * kwargs: passed to pandas&#39; hist method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_plot_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;Return Histogram&quot;</span><span class="p">)</span>

        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_series</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;</span> <span class="s2">&quot;2.&quot;</span><span class="p">:</span>
            <span class="c1"># normed deprecated</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ser</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;kde&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_prices</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">daily_prices</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;ffill&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_stats_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">()</span>

        <span class="n">short_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stat</span>

            <span class="c1"># blank row</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;rf&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">short_names</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">short_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">short_names</span><span class="p">)</span>

<div class="viewcode-block" id="PerformanceStats.to_csv"><a class="viewcode-back" href="../../ffn.html#ffn.core.PerformanceStats.to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CSV string with appropriate formatting.</span>
<span class="sd">        If path is not None, the string will be saved to file</span>
<span class="sd">        at path.</span>

<span class="sd">        Args:</span>
<span class="sd">            * sep (char): Separator</span>
<span class="sd">            * path (str): If None, CSV string returned. Else file written</span>
<span class="sd">                to specified path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Stat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_row</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stat</span>

            <span class="c1"># blank row</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;rf&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtp</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtn</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;unsupported format </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
                <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="GroupStats"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats">[docs]</a><span class="k">class</span> <span class="nc">GroupStats</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GroupStats enables one to compare multiple series side by side.</span>
<span class="sd">    It is a wrapper around a dict of {price.name: PerformanceStats} and</span>
<span class="sd">    provides many convenience methods.</span>

<span class="sd">    The order of the series passed in will be preserved.</span>
<span class="sd">    Individual PerformanceStats objects can be accessed via index</span>
<span class="sd">    position or name via the [] accessor.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series): Multiple price series to be compared.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        * stats (DataFrame): Dataframe containing stats for each</span>
<span class="sd">            series provided.  Stats in rows, series in columns.</span>
<span class="sd">        * lookback_returns (DataFrame): Returns for diffrent</span>
<span class="sd">            lookback periods (1m, 3m, 6m, ytd...)</span>
<span class="sd">            Period in rows, series in columns.</span>
<span class="sd">        * prices (DataFrame): The merged and rebased prices.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">prices</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;else&quot;</span><span class="p">)</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;n/a&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="n">names</span>

        <span class="c1"># store original prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="o">*</span><span class="n">prices</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># proper ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">]</span>

        <span class="c1"># check for duplicate columns</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;One or more data series provided&quot;</span><span class="p">,</span>
                <span class="s2">&quot;have same name! Please provide unique names&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># calculate stats for entire series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># if type(key) == int:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prices</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">prc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">PerformanceStats</span><span class="p">(</span><span class="n">prc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rf&quot;</span><span class="p">,</span> <span class="s2">&quot;Risk-free rate&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;total_return&quot;</span><span class="p">,</span> <span class="s2">&quot;Total Return&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;cagr&quot;</span><span class="p">,</span> <span class="s2">&quot;CAGR&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;max_drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;Max Drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;calmar&quot;</span><span class="p">,</span> <span class="s2">&quot;Calmar Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;mtd&quot;</span><span class="p">,</span> <span class="s2">&quot;MTD&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;three_month&quot;</span><span class="p">,</span> <span class="s2">&quot;3m&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;six_month&quot;</span><span class="p">,</span> <span class="s2">&quot;6m&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ytd&quot;</span><span class="p">,</span> <span class="s2">&quot;YTD&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;one_year&quot;</span><span class="p">,</span> <span class="s2">&quot;1Y&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;three_year&quot;</span><span class="p">,</span> <span class="s2">&quot;3Y (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;five_year&quot;</span><span class="p">,</span> <span class="s2">&quot;5Y (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ten_year&quot;</span><span class="p">,</span> <span class="s2">&quot;10Y (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;incep&quot;</span><span class="p">,</span> <span class="s2">&quot;Since Incep. (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Mean (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_vol&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Vol (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_skew&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Skew&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;daily_kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;Daily Kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;best_day&quot;</span><span class="p">,</span> <span class="s2">&quot;Best Day&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;worst_day&quot;</span><span class="p">,</span> <span class="s2">&quot;Worst Day&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Mean (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_vol&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Vol (ann.)&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_skew&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Skew&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;monthly_kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;Monthly Kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;best_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Best Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;worst_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Worst Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Sharpe&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Sortino&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Mean&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_vol&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Vol&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_skew&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Skew&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;yearly_kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;Yearly Kurt&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;best_year&quot;</span><span class="p">,</span> <span class="s2">&quot;Best Year&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;worst_year&quot;</span><span class="p">,</span> <span class="s2">&quot;Worst Year&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Drawdown&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_drawdown_days&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Drawdown Days&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_up_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Up Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;avg_down_month&quot;</span><span class="p">,</span> <span class="s2">&quot;Avg. Down Month&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;win_year_perc&quot;</span><span class="p">,</span> <span class="s2">&quot;Win Year %&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;twelve_month_win_perc&quot;</span><span class="p">,</span> <span class="s2">&quot;Win 12m %&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">stats</span>

    <span class="k">def</span> <span class="nf">_update_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># lookback returns dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookback_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="n">x</span><span class="o">.</span><span class="n">lookback_returns</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lookback_returns</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">stats</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()})</span>

    <span class="k">def</span> <span class="nf">_get_default_plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">get_freq_name</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">kind</span><span class="p">)</span>

<div class="viewcode-block" id="GroupStats.set_riskfree_rate"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.set_riskfree_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_riskfree_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rf</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set annual `risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_ property and calculate properly annualized</span>
<span class="sd">        monthly and daily rates. Then performance stats are recalculated.</span>
<span class="sd">        Affects only those instances of PerformanceStats that are children of</span>
<span class="sd">        this GroupStats object.</span>

<span class="sd">        Args:</span>
<span class="sd">            * rf (float, Series): Annual risk-free rate or risk-free rate price series</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_riskfree_rate</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>

        <span class="c1"># calculate stats for entire series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stats</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroupStats.set_date_range"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.set_date_range">[docs]</a>    <span class="k">def</span> <span class="nf">set_date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update date range of stats, charts, etc. If None then</span>
<span class="sd">        the original date range is used. So to reset to the original</span>
<span class="sd">        range, just call with no args.</span>

<span class="sd">        Args:</span>
<span class="sd">            * start (date): start date</span>
<span class="sd">            * end (end): end date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end</span> <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prices</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span></div>

<div class="viewcode-block" id="GroupStats.display"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display summary stats table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Stat&quot;</span><span class="p">]</span>
        <span class="n">first_row</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_row</span><span class="p">)</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stat</span>
            <span class="c1"># blank row</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>

                <span class="c1"># if rf is a series print nan</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;rf&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtp</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtn</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;unsupported format </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;firstrow&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="GroupStats.display_lookback_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.display_lookback_returns">[docs]</a>    <span class="k">def</span> <span class="nf">display_lookback_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays the current lookback returns for each series.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookback_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:,.2%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupStats.plot"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function for plotting the series.</span>

<span class="sd">        Args:</span>
<span class="sd">            * freq (str): Data frequency used for display purposes.</span>
<span class="sd">                Refer to pandas docs for valid freq strings.</span>
<span class="sd">            * figsize ((x,y)): figure size</span>
<span class="sd">            * title (str): Title if default not appropriate</span>
<span class="sd">            * logy (bool): log-scale for y axis</span>
<span class="sd">            * kwargs: passed to pandas&#39; plot method</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_plot_title</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;Equity Progression&quot;</span><span class="p">)</span>

        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_series</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">rebase</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ser</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="n">logy</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupStats.plot_scatter_matrix"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.plot_scatter_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">plot_scatter_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper around pandas&#39; scatter_matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            * freq (str): Data frequency used for display purposes.</span>
<span class="sd">                Refer to pandas docs for valid freq strings.</span>
<span class="sd">            * figsize ((x,y)): figure size</span>
<span class="sd">            * title (str): Title if default not appropriate</span>
<span class="sd">            * kwargs: passed to pandas&#39; scatter_matrix method</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_plot_title</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;Return Scatter Matrix&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_series</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="s2">&quot;scatter_matrix&quot;</span><span class="p">):</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">scatter_matrix</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">scatter_matrix</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupStats.plot_histograms"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.plot_histograms">[docs]</a>    <span class="k">def</span> <span class="nf">plot_histograms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper around pandas&#39; hist.</span>

<span class="sd">        Args:</span>
<span class="sd">            * freq (str): Data frequency used for display purposes.</span>
<span class="sd">                Refer to pandas docs for valid freq strings.</span>
<span class="sd">            * figsize ((x,y)): figure size</span>
<span class="sd">            * title (str): Title if default not appropriate</span>
<span class="sd">            * kwargs: passed to pandas&#39; hist method</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_plot_title</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;Return Histogram Matrix&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_series</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">ser</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupStats.plot_correlation"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.plot_correlation">[docs]</a>    <span class="k">def</span> <span class="nf">plot_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility function to plot correlations.</span>

<span class="sd">        Args:</span>
<span class="sd">            * freq (str): Pandas data frequency alias string</span>
<span class="sd">            * title (str): Plot title</span>
<span class="sd">            * figsize (tuple (x,y)): figure size</span>
<span class="sd">            * kwargs: passed to Pandas&#39; plot_corr_heatmap function</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_plot_title</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;Return Correlation Matrix&quot;</span><span class="p">)</span>

        <span class="n">rets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_series</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rets</span><span class="o">.</span><span class="n">plot_corr_heatmap</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span>

        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prices</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="s2">&quot;ffill&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GroupStats.to_csv"><a class="viewcode-back" href="../../ffn.html#ffn.core.GroupStats.to_csv">[docs]</a>    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a CSV string with appropriate formatting.</span>
<span class="sd">        If path is not None, the string will be saved to file</span>
<span class="sd">        at path.</span>

<span class="sd">        Args:</span>
<span class="sd">            * sep (char): Separator</span>
<span class="sd">            * path (str): If None, CSV string returned. Else file</span>
<span class="sd">                written to specified path.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">first_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Stat&quot;</span><span class="p">]</span>
        <span class="n">first_row</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">first_row</span><span class="p">))</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stat</span>
            <span class="c1"># blank row</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtp</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmtn</span><span class="p">(</span><span class="n">raw</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;dt&quot;</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;unsupported format </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
                <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="to_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_returns">[docs]</a><span class="k">def</span> <span class="nf">to_returns</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the simple arithmetic returns of a price series.</span>

<span class="sd">    Formula is: (t1 / t0) - 1</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices: Expects a price series</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="to_log_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_log_returns">[docs]</a><span class="k">def</span> <span class="nf">to_log_returns</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the log returns of a price series.</span>

<span class="sd">    Formula is: ln(p1/p0)</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices: Expects a price series</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="to_price_index"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_price_index">[docs]</a><span class="k">def</span> <span class="nf">to_price_index</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a price index given a series of returns.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns: Expects a return series</span>
<span class="sd">        * start (number): Starting level</span>

<span class="sd">    Assumes arithmetic returns.</span>

<span class="sd">    Formula is: cumprod (1+r)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">*</span> <span class="n">start</span></div>


<div class="viewcode-block" id="rebase"><a class="viewcode-back" href="../../ffn.html#ffn.core.rebase">[docs]</a><span class="k">def</span> <span class="nf">rebase</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rebase all series to a given intial value.</span>

<span class="sd">    This makes comparing/plotting different series</span>
<span class="sd">    together easier.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices: Expects a price series</span>
<span class="sd">        * value (number): starting value for all series.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">value</span></div>


<div class="viewcode-block" id="calc_perf_stats"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_perf_stats">[docs]</a><span class="k">def</span> <span class="nf">calc_perf_stats</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the performance statistics given an object.</span>
<span class="sd">    The object should be a Series of prices.</span>

<span class="sd">    A PerformanceStats object will be returned containing all the stats.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series): Series of prices</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PerformanceStats</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_stats"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_stats">[docs]</a><span class="k">def</span> <span class="nf">calc_stats</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates performance stats of a given object.</span>

<span class="sd">    If object is Series, a PerformanceStats object is</span>
<span class="sd">    returned. If object is DataFrame, a GroupStats object</span>
<span class="sd">    is returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series, DataFrame): Set of prices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PerformanceStats</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GroupStats</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">prices</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unsupported type&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="to_drawdown_series"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_drawdown_series">[docs]</a><span class="k">def</span> <span class="nf">to_drawdown_series</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the `drawdown &lt;https://www.investopedia.com/terms/d/drawdown.asp&gt;`_ series.</span>

<span class="sd">    This returns a series representing a drawdown.</span>
<span class="sd">    When the price is at all time highs, the drawdown</span>
<span class="sd">    is 0. However, when prices are below high water marks,</span>
<span class="sd">    the drawdown series = current / hwm - 1</span>

<span class="sd">    The max drawdown can be obtained by simply calling .min()</span>
<span class="sd">    on the result (since the drawdown series is negative)</span>

<span class="sd">    Method ignores all gaps of NaN&#39;s in the price series.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series or DataFrame): Series of prices.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make a copy so that we don&#39;t modify original data</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Fill NaN&#39;s with previous values</span>
    <span class="n">drawdown</span> <span class="o">=</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>

    <span class="c1"># Ignore problems with NaN&#39;s in the beginning</span>
    <span class="n">drawdown</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span>

    <span class="c1"># Rolling maximum</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drawdown</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">roll_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">drawdown</span><span class="p">:</span>
            <span class="n">roll_max</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">drawdown</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">roll_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">drawdown</span><span class="p">)</span>

    <span class="n">drawdown</span> <span class="o">=</span> <span class="n">drawdown</span> <span class="o">/</span> <span class="n">roll_max</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">drawdown</span></div>


<div class="viewcode-block" id="calc_mtd"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_mtd">[docs]</a><span class="k">def</span> <span class="nf">calc_mtd</span><span class="p">(</span><span class="n">daily_prices</span><span class="p">,</span> <span class="n">monthly_prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates mtd return of a price series.</span>
<span class="sd">    Use daily_prices if prices are only available from same month</span>
<span class="sd">    else use monthly_prices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">monthly_prices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">daily_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">daily_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">daily_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">monthly_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="calc_ytd"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_ytd">[docs]</a><span class="k">def</span> <span class="nf">calc_ytd</span><span class="p">(</span><span class="n">daily_prices</span><span class="p">,</span> <span class="n">yearly_prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates ytd return of a price series.</span>
<span class="sd">    Use daily_prices if prices are only available from same year</span>
<span class="sd">    else use yearly_prices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yearly_prices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">daily_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">daily_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">daily_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">yearly_prices</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="calc_max_drawdown"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_max_drawdown">[docs]</a><span class="k">def</span> <span class="nf">calc_max_drawdown</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the max drawdown of a price series. If you want the</span>
<span class="sd">    actual drawdown series, please use to_drawdown_series.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">prices</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">expanding</span><span class="p">(</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="drawdown_details"><a class="viewcode-back" href="../../ffn.html#ffn.core.drawdown_details">[docs]</a><span class="k">def</span> <span class="nf">drawdown_details</span><span class="p">(</span><span class="n">drawdown</span><span class="p">,</span> <span class="n">index_type</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a data frame with start, end, days (duration) and</span>
<span class="sd">    drawdown for each drawdown in a drawdown series.</span>

<span class="sd">    .. note::</span>

<span class="sd">        days are actual calendar days, not trading days</span>

<span class="sd">    Args:</span>
<span class="sd">        * drawdown (pandas.Series): A drawdown Series</span>
<span class="sd">            (can be obtained w/ drawdown(prices).</span>
<span class="sd">    Returns:</span>
<span class="sd">        * pandas.DataFrame -- A data frame with the following</span>
<span class="sd">            columns: start, end, days, drawdown.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_zero</span> <span class="o">=</span> <span class="n">drawdown</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c1"># find start dates (first day where dd is non-zero after a zero)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="o">~</span><span class="n">is_zero</span> <span class="o">&amp;</span> <span class="n">is_zero</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">start</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># NOQA</span>

    <span class="c1"># find end dates (first day where dd is 0 after non-zero)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">is_zero</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">is_zero</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="n">end</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># NOQA</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># start.empty</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># drawdown has no end (end period in dd)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># end.empty</span>
        <span class="n">end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># if the first drawdown start is larger than the first drawdown end it</span>
    <span class="c1"># means the drawdown series begins in a drawdown and therefore we must add</span>
    <span class="c1"># the first index to the start series</span>
    <span class="k">if</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">start</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># if the last start is greater than the end then we must add the last index</span>
    <span class="c1"># to the end series since the drawdown series must finish with a drawdown</span>
    <span class="k">if</span> <span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drawdown</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;End&quot;</span><span class="p">,</span> <span class="s2">&quot;Length&quot;</span><span class="p">,</span> <span class="s2">&quot;drawdown&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">drawdown</span><span class="p">[</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">:</span> <span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">index_type</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="calc_cagr"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_cagr">[docs]</a><span class="k">def</span> <span class="nf">calc_cagr</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the `CAGR (compound annual growth rate) &lt;https://www.investopedia.com/terms/c/cagr.asp&gt;`_ for a given price series.</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (pandas.Series): A Series of prices.</span>
<span class="sd">    Returns:</span>
<span class="sd">        * float -- cagr.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">year_frac</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="calc_risk_return_ratio"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_risk_return_ratio">[docs]</a><span class="k">def</span> <span class="nf">calc_risk_return_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the return / risk ratio. Basically the</span>
<span class="sd">    `Sharpe ratio &lt;https://www.investopedia.com/terms/s/sharperatio.asp&gt;`_ without factoring in the `risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">calc_sharpe</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_sharpe"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_sharpe">[docs]</a><span class="k">def</span> <span class="nf">calc_sharpe</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annualize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the `Sharpe ratio &lt;https://www.investopedia.com/terms/s/sharperatio.asp&gt;`_</span>
<span class="sd">    (see `Sharpe vs. Sortino &lt;https://www.investopedia.com/ask/answers/010815/what-difference-between-sharpe-ratio-and-sortino-ratio.asp&gt;`_).</span>

<span class="sd">    If rf is non-zero and a float, you must specify nperiods. In this case, rf is assumed</span>
<span class="sd">    to be expressed in yearly (annualized) terms.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (Series, DataFrame): Input return series</span>
<span class="sd">        * rf (float, Series): `Risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_ expressed as a yearly (annualized) return or return series</span>
<span class="sd">        * nperiods (int): Frequency of returns (252 for daily, 12 for monthly,</span>
<span class="sd">            etc.)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nperiods</span> <span class="o">=</span> <span class="n">infer_freq</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rf</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must provide nperiods if rf != 0&quot;</span><span class="p">)</span>

    <span class="n">er</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">to_excess_returns</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="n">nperiods</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">er</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">std</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annualize</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nperiods</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">res</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nperiods</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="calc_information_ratio"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_information_ratio">[docs]</a><span class="k">def</span> <span class="nf">calc_information_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">benchmark_returns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the `Information ratio &lt;https://www.investopedia.com/terms/i/informationratio.asp&gt;`_ (or `from Wikipedia &lt;http://en.wikipedia.org/wiki/Information_ratio&gt;`_).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diff_rets</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">benchmark_returns</span>
    <span class="n">diff_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff_rets</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">diff_std</span><span class="p">)</span> <span class="ow">or</span> <span class="n">diff_std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">diff_rets</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">diff_std</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_prob_mom"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_prob_mom">[docs]</a><span class="k">def</span> <span class="nf">calc_prob_mom</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">other_returns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `Probabilistic momentum &lt;http://cssanalytics.wordpress.com/2014/01/28/are-simple-momentum-strategies-too-dumb-introducing-probabilistic-momentum/&gt;`_ (see `momentum investing &lt;https://www.investopedia.com/terms/m/momentum_investing.asp&gt;`_)</span>

<span class="sd">    Basically the &quot;probability or confidence that one asset</span>
<span class="sd">    is going to outperform the other&quot;.</span>

<span class="sd">    Source:</span>
<span class="sd">        http://cssanalytics.wordpress.com/2014/01/28/are-simple-momentum-strategies-too-dumb-introducing-probabilistic-momentum/ # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">calc_information_ratio</span><span class="p">(</span><span class="n">other_returns</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_total_return"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_total_return">[docs]</a><span class="k">def</span> <span class="nf">calc_total_return</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the total return of a series.</span>

<span class="sd">    last / first - 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="year_frac"><a class="viewcode-back" href="../../ffn.html#ffn.core.year_frac">[docs]</a><span class="k">def</span> <span class="nf">year_frac</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to excel&#39;s yearfrac function. Returns</span>
<span class="sd">    a year fraction between two dates (i.e. 1.53 years).</span>

<span class="sd">    Approximation using the average number of seconds</span>
<span class="sd">    in a year.</span>

<span class="sd">    Args:</span>
<span class="sd">        * start (datetime): start date</span>
<span class="sd">        * end (datetime): end date</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start cannot be larger than end&quot;</span><span class="p">)</span>

    <span class="c1"># obviously not perfect but good enough</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">31557600</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge"><a class="viewcode-back" href="../../ffn.html#ffn.core.merge">[docs]</a><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="o">*</span><span class="n">series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge Series and/or DataFrames together.</span>

<span class="sd">    Returns a DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">series</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">tmpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span>
            <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpdf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unsupported merge type&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="drop_duplicate_cols"><a class="viewcode-back" href="../../ffn.html#ffn.core.drop_duplicate_cols">[docs]</a><span class="k">def</span> <span class="nf">drop_duplicate_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes duplicate columns from a dataframe</span>
<span class="sd">    and keeps column w/ longest history</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># get subset of df w/ colname n</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="c1"># make unique colnames</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="c1"># get colname w/ max # of data</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="c1"># drop all columns of name n from original df</span>
            <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="c1"># update original df w/ longest col with name n</span>
            <span class="n">df</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="to_monthly"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_monthly">[docs]</a><span class="k">def</span> <span class="nf">to_monthly</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;end&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience method that wraps asfreq_actual</span>
<span class="sd">    with &#39;M&#39; param (method=&#39;ffill&#39;, how=&#39;end&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">asfreq_actual</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">)</span></div>


<div class="viewcode-block" id="asfreq_actual"><a class="viewcode-back" href="../../ffn.html#ffn.core.asfreq_actual">[docs]</a><span class="k">def</span> <span class="nf">asfreq_actual</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to pandas&#39; asfreq but keeps the actual dates.</span>
<span class="sd">    For example, if last data point in Jan is on the 29th,</span>
<span class="sd">    that date will be used instead of the 31st.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">series</span>
    <span class="n">is_series</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">is_series</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">series</span><span class="p">})</span>

    <span class="c1"># add date column</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">orig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;dt&quot;</span><span class="p">:</span> <span class="n">orig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">orig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="c1"># fetch dates</span>
    <span class="n">dts</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dts</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">is_series</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="calc_inv_vol_weights"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_inv_vol_weights">[docs]</a><span class="k">def</span> <span class="nf">calc_inv_vol_weights</span><span class="p">(</span><span class="n">returns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates weights proportional to inverse volatility of each column.</span>

<span class="sd">    Returns weights that are inversely proportional to the column&#39;s</span>
<span class="sd">    volatility resulting in a set of portfolio weights where each position</span>
<span class="sd">    has the same level of volatility.</span>

<span class="sd">    Note, that assets with returns all equal to NaN or 0 are excluded from</span>
<span class="sd">    the portfolio (their weight is set to NaN).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Series {col_name: weight}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calc vols</span>
    <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">vol</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">vol</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">volsum</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">volsum</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_mean_var_weights"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_mean_var_weights">[docs]</a><span class="k">def</span> <span class="nf">calc_mean_var_weights</span><span class="p">(</span>
    <span class="n">returns</span><span class="p">,</span> <span class="n">weight_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">rf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">covar_method</span><span class="o">=</span><span class="s2">&quot;ledoit-wolf&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the mean-variance weights given a DataFrame of returns.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (DataFrame): Returns for multiple securities.</span>
<span class="sd">        * weight_bounds ((low, high)): Weigh limits for optimization.</span>
<span class="sd">        * rf (float): `Risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_ used in utility calculation</span>
<span class="sd">        * covar_method (str): Covariance matrix estimation method.</span>
<span class="sd">            Currently supported:</span>
<span class="sd">                - `ledoit-wolf &lt;http://www.ledoit.net/honey.pdf&gt;`_</span>
<span class="sd">                - standard</span>
<span class="sd">        * options (dict): options for minimizing, e.g. {&#39;maxiter&#39;: 10000 }</span>

<span class="sd">    Returns:</span>
<span class="sd">        Series {col_name: weight}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fitness</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">exp_rets</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">rf</span><span class="p">):</span>
        <span class="c1"># portfolio mean</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">exp_rets</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span>
        <span class="c1"># portfolio var</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">covar</span><span class="p">),</span> <span class="n">weights</span><span class="p">)</span>
        <span class="c1"># utility - i.e. sharpe ratio</span>
        <span class="n">util</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="n">rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="c1"># negative because we want to maximize and optimizer</span>
        <span class="c1"># minimizes metric</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">util</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># expected return defaults to mean return by default</span>
    <span class="n">exp_rets</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># calc covariance matrix</span>
    <span class="k">if</span> <span class="n">covar_method</span> <span class="o">==</span> <span class="s2">&quot;ledoit-wolf&quot;</span><span class="p">:</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">ledoit_wolf</span><span class="p">(</span><span class="n">returns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">covar_method</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;covar_method not implemented&quot;</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">n</span><span class="p">])</span> <span class="o">/</span> <span class="n">n</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">weight_bounds</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="c1"># sum of weights must be equal to 1</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">W</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>
    <span class="n">optimized</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">fitness</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">,</span>
        <span class="p">(</span><span class="n">exp_rets</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">rf</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># check if success</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optimized</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">optimized</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># return weight vector</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">optimized</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)})</span></div>


<span class="k">def</span> <span class="nf">_erc_weights_slsqp</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">maximum_iterations</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the equal risk contribution / risk parity weights given</span>
<span class="sd">        a DataFrame of returns.</span>

<span class="sd">    Args:</span>
<span class="sd">    * x0 (np.array): Starting asset weights.</span>
<span class="sd">    * cov (np.array): covariance matrix.</span>
<span class="sd">    * b (np.array): Risk target weights. By definition target total risk contributions are all equal which makes this redundant.</span>
<span class="sd">    * maximum_iterations (int): Maximum iterations in iterative solutions.</span>
<span class="sd">    * tolerance (float): Tolerance level in iterative solutions.</span>

<span class="sd">    Returns:</span>
<span class="sd">    np.array {weight}</span>

<span class="sd">    You can read more about ERC at</span>
<span class="sd">    http://thierry-roncalli.com/download/erc.pdf</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fitness</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">covar</span><span class="p">):</span>
        <span class="c1"># total risk contributions</span>
        <span class="c1"># trc = weights*np.matmul(covar,weights)/np.sqrt(np.matmul(weights.T,np.matmul(covar,weights)))</span>

        <span class="c1"># instead of using the true definition for trc we will use the optimization on page 5</span>
        <span class="n">trc</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">covar</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trc</span><span class="p">)</span>
        <span class="c1"># sum of squared differences of total risk contributions</span>
        <span class="n">sse</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="c1"># switched from squared deviations to absolute deviations to avoid numerical instability</span>
                <span class="n">sse</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">trc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">trc</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="c1"># minimizes metric</span>
        <span class="k">return</span> <span class="n">sse</span>

    <span class="c1"># nonnegative</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">))]</span>
    <span class="c1"># sum of weights must be equal to 1</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">W</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="n">maximum_iterations</span><span class="p">}</span>

    <span class="n">optimized</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
        <span class="n">fitness</span><span class="p">,</span>
        <span class="n">x0</span><span class="p">,</span>
        <span class="p">(</span><span class="n">cov</span><span class="p">),</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># check if success</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">optimized</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">optimized</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># return weight vector</span>
    <span class="k">return</span> <span class="n">optimized</span><span class="o">.</span><span class="n">x</span>


<span class="k">def</span> <span class="nf">_erc_weights_ccd</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">maximum_iterations</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the equal risk contribution / risk parity weights given</span>
<span class="sd">    a DataFrame of returns.</span>

<span class="sd">    Args:</span>
<span class="sd">        * x0 (np.array): Starting asset weights.</span>
<span class="sd">        * cov (np.array): covariance matrix.</span>
<span class="sd">        * b (np.array): Risk target weights.</span>
<span class="sd">        * maximum_iterations (int): Maximum iterations in iterative solutions.</span>
<span class="sd">        * tolerance (float): Tolerance level in iterative solutions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array {weight}</span>

<span class="sd">    Reference:</span>
<span class="sd">        Griveau-Billion, Theophile and Richard, Jean-Charles and Roncalli,</span>
<span class="sd">        Thierry, A Fast Algorithm for Computing High-Dimensional Risk Parity</span>
<span class="sd">        Portfolios (2013).</span>
<span class="sd">        Available at SSRN: https://ssrn.com/abstract=2325255</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ctr</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maximum_iterations</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">ctr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sigma_x</span>

            <span class="n">x_tilde</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">beta</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">x_i</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">ctr</span> <span class="o">=</span> <span class="n">ctr</span> <span class="o">-</span> <span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_i</span> <span class="o">+</span> <span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_tilde</span>
            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">sigma_x</span> <span class="o">*</span> <span class="n">sigma_x</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_i</span> <span class="o">*</span> <span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x_i</span> <span class="o">*</span> <span class="n">x_i</span> <span class="o">*</span> <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span>
            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">sigma_x</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_tilde</span> <span class="o">*</span> <span class="n">cov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_tilde</span> <span class="o">*</span> <span class="n">x_tilde</span> <span class="o">*</span> <span class="n">var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># check convergence</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># no solution found</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s2">&quot;No solution found after </span><span class="si">{0}</span><span class="s2"> iterations.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maximum_iterations</span><span class="p">)</span>
    <span class="p">)</span>


<div class="viewcode-block" id="calc_erc_weights"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_erc_weights">[docs]</a><span class="k">def</span> <span class="nf">calc_erc_weights</span><span class="p">(</span>
    <span class="n">returns</span><span class="p">,</span>
    <span class="n">initial_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">risk_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">covar_method</span><span class="o">=</span><span class="s2">&quot;ledoit-wolf&quot;</span><span class="p">,</span>
    <span class="n">risk_parity_method</span><span class="o">=</span><span class="s2">&quot;ccd&quot;</span><span class="p">,</span>
    <span class="n">maximum_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the equal risk contribution / risk parity weights given a</span>
<span class="sd">    DataFrame of returns.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (DataFrame): Returns for multiple securities.</span>
<span class="sd">        * initial_weights (list): Starting asset weights [default inverse vol].</span>
<span class="sd">        * risk_weights (list): Risk target weights [default equal weight].</span>
<span class="sd">        * covar_method (str): Covariance matrix estimation method.</span>
<span class="sd">            Currently supported:</span>
<span class="sd">                - `ledoit-wolf &lt;http://www.ledoit.net/honey.pdf&gt;`_ [default]</span>
<span class="sd">                - standard</span>
<span class="sd">        * risk_parity_method (str): Risk parity estimation method.</span>
<span class="sd">            Currently supported:</span>
<span class="sd">                - ccd (cyclical coordinate descent)[default]</span>
<span class="sd">                - slsqp (scipy&#39;s implementation of sequential least squares programming)</span>
<span class="sd">        * maximum_iterations (int): Maximum iterations in iterative solutions.</span>
<span class="sd">        * tolerance (float): Tolerance level in iterative solutions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Series {col_name: weight}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># calc covariance matrix</span>
    <span class="k">if</span> <span class="n">covar_method</span> <span class="o">==</span> <span class="s2">&quot;ledoit-wolf&quot;</span><span class="p">:</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">ledoit_wolf</span><span class="p">(</span><span class="n">returns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">covar_method</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;covar_method not implemented&quot;</span><span class="p">)</span>

    <span class="c1"># initial weights (default to inverse vol)</span>
    <span class="k">if</span> <span class="n">initial_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inv_vol</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">covar</span><span class="p">))</span>
        <span class="n">initial_weights</span> <span class="o">=</span> <span class="n">inv_vol</span> <span class="o">/</span> <span class="n">inv_vol</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># default to equal risk weight</span>
    <span class="k">if</span> <span class="n">risk_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">risk_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

    <span class="c1"># calc risk parity weights matrix</span>
    <span class="k">if</span> <span class="n">risk_parity_method</span> <span class="o">==</span> <span class="s2">&quot;ccd&quot;</span><span class="p">:</span>
        <span class="c1"># cyclical coordinate descent implementation</span>
        <span class="n">erc_weights</span> <span class="o">=</span> <span class="n">_erc_weights_ccd</span><span class="p">(</span>
            <span class="n">initial_weights</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">risk_weights</span><span class="p">,</span> <span class="n">maximum_iterations</span><span class="p">,</span> <span class="n">tolerance</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">risk_parity_method</span> <span class="o">==</span> <span class="s2">&quot;slsqp&quot;</span><span class="p">:</span>
        <span class="c1"># scipys slsqp optimizer</span>
        <span class="n">erc_weights</span> <span class="o">=</span> <span class="n">_erc_weights_slsqp</span><span class="p">(</span>
            <span class="n">initial_weights</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">risk_weights</span><span class="p">,</span> <span class="n">maximum_iterations</span><span class="p">,</span> <span class="n">tolerance</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;risk_parity_method not implemented&quot;</span><span class="p">)</span>

    <span class="c1"># return erc weights vector</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">erc_weights</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;erc&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_num_days_required"><a class="viewcode-back" href="../../ffn.html#ffn.core.get_num_days_required">[docs]</a><span class="k">def</span> <span class="nf">get_num_days_required</span><span class="p">(</span>
    <span class="n">offset</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">perc_required</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">annualization_factor</span><span class="o">=</span><span class="mi">252</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the number of days required to assume that data is OK.</span>

<span class="sd">    Helper function used to determine if there are enough &quot;good&quot; data</span>
<span class="sd">    days over a given period.</span>

<span class="sd">    Args:</span>
<span class="sd">        * offset (DateOffset): Offset (lookback) period.</span>
<span class="sd">        * period (str): Period string.</span>
<span class="sd">        * perc_required (float): percentage of number of days</span>
<span class="sd">            expected required.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2010-01-01&quot;</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>
    <span class="c1"># convert to &#39;trading days&#39; - rough guestimate</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mf">0.69</span>

    <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">days</span> <span class="o">*</span> <span class="n">perc_required</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="n">days</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="n">perc_required</span>
    <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="n">days</span> <span class="o">/</span> <span class="n">annualization_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">perc_required</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;period not supported. Supported periods are d, m, y&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">req</span></div>


<div class="viewcode-block" id="calc_clusters"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_clusters">[docs]</a><span class="k">def</span> <span class="nf">calc_clusters</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the clusters based on k-means</span>
<span class="sd">    clustering.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (pd.DataFrame): DataFrame of returns</span>
<span class="sd">        * n (int): Specify # of clusters. If None, this</span>
<span class="sd">            will be automatically determined</span>
<span class="sd">        * plot (bool): Show plot?</span>

<span class="sd">    Returns:</span>
<span class="sd">        * dict with structure: {cluster# : [col names]}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate correlation</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

    <span class="c1"># calculate dissimilarity matrix</span>
    <span class="n">diss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">corr</span>

    <span class="c1"># scale down to 2 dimensions using MDS</span>
    <span class="c1"># (multi-dimensional scaling) using the</span>
    <span class="c1"># dissimilarity matrix</span>
    <span class="n">mds</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">manifold</span><span class="o">.</span><span class="n">MDS</span><span class="p">(</span><span class="n">dissimilarity</span><span class="o">=</span><span class="s2">&quot;precomputed&quot;</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">mds</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">diss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">routine</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="c1"># fit KMeans</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">km_fit</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">km_fit</span><span class="o">.</span><span class="n">labels_</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">km_fit</span><span class="o">.</span><span class="n">cluster_centers_</span>

        <span class="c1"># get {ticker: label} mappings</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>

        <span class="c1"># print % of var explained</span>
        <span class="n">totss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">withinss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># column average fot totss</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">withinss</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">centers</span><span class="p">[</span><span class="n">lbl</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">totss</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">avg</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pvar_expl</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">withinss</span> <span class="o">/</span> <span class="n">totss</span>

        <span class="k">return</span> <span class="n">mappings</span><span class="p">,</span> <span class="n">pvar_expl</span><span class="p">,</span> <span class="n">labels</span>

    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">routine</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mf">0.6666666666</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">routine</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># sanitize return value</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># map as such {cluster: [list of tickers], cluster2: [...]}</span>
    <span class="n">inv_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">inv_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">inv_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inv_map</span></div>


<div class="viewcode-block" id="calc_ftca"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_ftca">[docs]</a><span class="k">def</span> <span class="nf">calc_ftca</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of David Varadi&#39;s `Fast Threshold Clustering Algorithm (FTCA) &lt;http://cssanalytics.wordpress.com/2013/11/26/fast-threshold-clustering-algorithm-ftca/&gt;`_.</span>

<span class="sd">    http://cssanalytics.wordpress.com/2013/11/26/fast-threshold-clustering-algorithm-ftca/  # NOQA</span>

<span class="sd">    More stable than k-means for clustering purposes.</span>
<span class="sd">    If you want more clusters, use a higher threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns - expects a pandas dataframe of returns where</span>
<span class="sd">            each column is the name of a given security.</span>
<span class="sd">        * threshold (float): Threshold parameter - use higher value</span>
<span class="sd">            for more clusters. Basically controls how similar</span>
<span class="sd">            (correlated) series have to be.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict of cluster name (a number) and list of securities in cluster</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cluster index (name)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># correlation matrix</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
    <span class="c1"># remaining securities to cluster</span>
    <span class="n">remain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remain</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># if only one left then create cluster and finish</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">remain</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># if not then we have some work to do</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># filter down correlation matrix to current remain</span>
            <span class="n">cur_corr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">remain</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">remain</span><span class="p">]</span>
            <span class="c1"># get mean correlations, ordered</span>
            <span class="n">mc</span> <span class="o">=</span> <span class="n">cur_corr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
            <span class="c1"># get lowest and highest mean correlation</span>
            <span class="n">low</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># case if corr(high,low) &gt; threshold</span>
            <span class="k">if</span> <span class="n">corr</span><span class="p">[</span><span class="n">high</span><span class="p">][</span><span class="n">low</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># new cluster for high and low</span>
                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">]</span>
                <span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>
                <span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>

                <span class="n">rmv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remain</span><span class="p">:</span>
                    <span class="n">avg_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">high</span><span class="p">]</span> <span class="o">+</span> <span class="n">corr</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">low</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
                    <span class="k">if</span> <span class="n">avg_corr</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">rmv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="p">[</span><span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rmv</span><span class="p">]</span>

                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remain</span><span class="p">)</span>

            <span class="c1"># otherwise we are creating two clusters - one for high</span>
            <span class="c1"># and one for low</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># add cluster with HC</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">high</span><span class="p">]</span>
                <span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">high</span><span class="p">)</span>
                <span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">low</span><span class="p">)</span>

                <span class="n">rmv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remain</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">corr</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">high</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">rmv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="p">[</span><span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rmv</span><span class="p">]</span>

                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">low</span><span class="p">]</span>

                <span class="n">rmv</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">remain</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">corr</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">low</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                        <span class="n">rmv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="p">[</span><span class="n">remain</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rmv</span><span class="p">]</span>

                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remain</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="limit_weights"><a class="viewcode-back" href="../../ffn.html#ffn.core.limit_weights">[docs]</a><span class="k">def</span> <span class="nf">limit_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits weights and redistributes excedent amount</span>
<span class="sd">    proportionally.</span>

<span class="sd">    ex:</span>
<span class="sd">        - weights are {a: 0.7, b: 0.2, c: 0.1}</span>
<span class="sd">        - call with limit=0.5</span>
<span class="sd">        - excess 0.2 in a is ditributed to b and c</span>
<span class="sd">            proportionally.</span>
<span class="sd">            - result is {a: 0.5, b: 0.33, c: 0.167}</span>

<span class="sd">    Args:</span>
<span class="sd">        * weights (Series): A series describing the weights</span>
<span class="sd">        * limit (float): Maximum weight allowed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid limit -&gt; 1 / limit must be &lt;= len(weights)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Expecting weights (that sum to 1) - sum is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">to_rebalance</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">]</span> <span class="o">-</span> <span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">]</span>
    <span class="n">ok</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ok</span> <span class="o">/</span> <span class="n">ok</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">*</span> <span class="n">to_rebalance</span>

    <span class="n">res</span><span class="p">[</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
    <span class="n">res</span><span class="p">[</span><span class="n">res</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">]</span> <span class="o">=</span> <span class="n">ok</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">limit_weights</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="random_weights"><a class="viewcode-back" href="../../ffn.html#ffn.core.random_weights">[docs]</a><span class="k">def</span> <span class="nf">random_weights</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate pseudo-random weights.</span>

<span class="sd">    Returns a list of random weights that is of length</span>
<span class="sd">    n, where each weight is in the range bounds, and</span>
<span class="sd">    where the weights sum up to total.</span>

<span class="sd">    Useful for creating random portfolios when benchmarking.</span>

<span class="sd">    Args:</span>
<span class="sd">        * n (int): number of random weights</span>
<span class="sd">        * bounds ((low, high)): bounds for each weight</span>
<span class="sd">        * total (float): total sum of the weights</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="n">low</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Higher bound must be greater or &quot;</span> <span class="s2">&quot;equal to lower bound&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">*</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">*</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">total</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;solution not possible with given n and bounds&quot;</span><span class="p">)</span>

    <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">tgt</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">rhigh</span> <span class="o">=</span> <span class="n">rn</span> <span class="o">*</span> <span class="n">high</span>
        <span class="n">rlow</span> <span class="o">=</span> <span class="n">rn</span> <span class="o">*</span> <span class="n">low</span>

        <span class="n">lowb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">rhigh</span> <span class="o">-</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">low</span><span class="p">)</span>
        <span class="n">highb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="n">rlow</span> <span class="o">-</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>

        <span class="n">rw</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lowb</span><span class="p">,</span> <span class="n">highb</span><span class="p">)</span>
        <span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rw</span>

        <span class="n">tgt</span> <span class="o">+=</span> <span class="n">rw</span>

    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">w</span></div>


<div class="viewcode-block" id="plot_heatmap"><a class="viewcode-back" href="../../ffn.html#ffn.core.plot_heatmap">[docs]</a><span class="k">def</span> <span class="nf">plot_heatmap</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Heatmap&quot;</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">show_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">label_fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">label_color</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdBu&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a heatmap using matplotlib&#39;s pcolor.</span>

<span class="sd">    Args:</span>
<span class="sd">        * data (DataFrame): DataFrame to plot. Usually small matrix (ex.</span>
<span class="sd">            correlation matrix).</span>
<span class="sd">        * title (string): Plot title</span>
<span class="sd">        * show_legend (bool): Show color legend</span>
<span class="sd">        * show_labels (bool): Show value labels</span>
<span class="sd">        * label_fmt (str): Label format string</span>
<span class="sd">        * vmin (float): Min value for scale</span>
<span class="sd">        * vmax (float): Max value for scale</span>
<span class="sd">        * cmap (string): Color map</span>
<span class="sd">        * kwargs: Passed to matplotlib&#39;s pcolor</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">heatmap</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="c1"># for some reason heatmap has the y values backwards....</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_legend</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_labels</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">label_fmt</span><span class="p">),</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">label_color</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plt</span></div>


<div class="viewcode-block" id="plot_corr_heatmap"><a class="viewcode-back" href="../../ffn.html#ffn.core.plot_corr_heatmap">[docs]</a><span class="k">def</span> <span class="nf">plot_corr_heatmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the correlation heatmap for a given DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">plot_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="rollapply"><a class="viewcode-back" href="../../ffn.html#ffn.core.rollapply">[docs]</a><span class="k">def</span> <span class="nf">rollapply</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a function fn over a rolling window of size window.</span>

<span class="sd">    Args:</span>
<span class="sd">        * data (Series or DataFrame): Series or DataFrame</span>
<span class="sd">        * window (int): Window size</span>
<span class="sd">        * fn (function): Function to apply over the rolling window.</span>
<span class="sd">            For a series, the return value is expected to be a single</span>
<span class="sd">            number. For a DataFrame, it shuold return a new row.</span>

<span class="sd">    Returns:</span>
<span class="sd">        * Object of same dimensions as data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">res</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">_winsorize_wrapper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps scipy winsorize function to drop na&#39;s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="n">notnanx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">notnanx</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mstats</span><span class="o">.</span><span class="n">winsorize</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">notnanx</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mstats</span><span class="o">.</span><span class="n">winsorize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">)</span>


<div class="viewcode-block" id="winsorize"><a class="viewcode-back" href="../../ffn.html#ffn.core.winsorize">[docs]</a><span class="k">def</span> <span class="nf">winsorize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `Winsorize &lt;https://en.wikipedia.org/wiki/Winsorizing&gt;`_ values based on limits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># operate on copy</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_winsorize_wrapper</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">limits</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">_winsorize_wrapper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">limits</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="rescale"><a class="viewcode-back" href="../../ffn.html#ffn.core.rescale">[docs]</a><span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rescale values to fit a certain range [min, max]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">innerfn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="p">[</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">innerfn</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                <span class="nb">min</span><span class="p">,</span>
                <span class="nb">max</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">innerfn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="annualize"><a class="viewcode-back" href="../../ffn.html#ffn.core.annualize">[docs]</a><span class="k">def</span> <span class="nf">annualize</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">durations</span><span class="p">,</span> <span class="n">one_year</span><span class="o">=</span><span class="mf">365.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Annualize returns using their respective durations.</span>

<span class="sd">    Formula used is:</span>
<span class="sd">        (1 + returns) ** (1 / (durations / one_year)) - 1</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">returns</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">durations</span> <span class="o">/</span> <span class="n">one_year</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0</span></div>


<div class="viewcode-block" id="deannualize"><a class="viewcode-back" href="../../ffn.html#ffn.core.deannualize">[docs]</a><span class="k">def</span> <span class="nf">deannualize</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">nperiods</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert return expressed in annual terms on a different basis.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (float, Series, DataFrame): Return(s)</span>
<span class="sd">        * nperiods (int): Target basis, typically 252 for daily, 12 for</span>
<span class="sd">            monthly, etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nperiods</span> <span class="o">=</span> <span class="n">infer_freq</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">returns</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">nperiods</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span></div>


<div class="viewcode-block" id="infer_freq"><a class="viewcode-back" href="../../ffn.html#ffn.core.infer_freq">[docs]</a><span class="k">def</span> <span class="nf">infer_freq</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer the most likely frequency given the input index. If the frequency is</span>
<span class="sd">    uncertain or index is not DateTime like, just return None</span>
<span class="sd">        Args:</span>
<span class="sd">            * data (DataFrame, Series): Any timeseries dataframe or series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">infer_freq</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="infer_nperiods"><a class="viewcode-back" href="../../ffn.html#ffn.core.infer_nperiods">[docs]</a><span class="k">def</span> <span class="nf">infer_nperiods</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">annualization_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">annualization_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">annualization_factor</span> <span class="o">=</span> <span class="n">TRADING_DAYS_PER_YEAR</span>

    <span class="n">freq</span> <span class="o">=</span> <span class="n">infer_freq</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">whole_periods_str_to_nperiods</span><span class="p">(</span><span class="n">freq</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="ow">or</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">12</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">annualization_factor</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">annualization_factor</span> <span class="o">*</span> <span class="mi">24</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">annualization_factor</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">annualization_factor</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">whole_periods_str_to_nperiods</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">whole_periods_str</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">num_str</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_str</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">num</span> <span class="o">*</span> <span class="n">whole_periods_str_to_nperiods</span><span class="p">(</span><span class="n">whole_periods_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="calc_sortino_ratio"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_sortino_ratio">[docs]</a><span class="k">def</span> <span class="nf">calc_sortino_ratio</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annualize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the `Sortino ratio &lt;https://www.investopedia.com/terms/s/sortinoratio.asp&gt;`_ given a series of returns</span>
<span class="sd">    (see `Sharpe vs. Sortino &lt;https://www.investopedia.com/ask/answers/010815/what-difference-between-sharpe-ratio-and-sortino-ratio.asp&gt;`_).</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (Series or DataFrame): Returns</span>
<span class="sd">        * rf (float, Series): `Risk-free rate &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_ expressed in yearly (annualized) terms or return series.</span>
<span class="sd">        * nperiods (int): Number of periods used for annualization. Must be</span>
<span class="sd">            provided if rf is non-zero and rf is not a price series</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rf</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;nperiods must be set if rf != 0 and rf is not a price series&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nperiods</span> <span class="o">=</span> <span class="n">infer_freq</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="n">er</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">to_excess_returns</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="n">nperiods</span><span class="p">)</span>

    <span class="n">negative_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">er</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">negative_returns</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">std</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annualize</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nperiods</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">res</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nperiods</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="to_excess_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_excess_returns">[docs]</a><span class="k">def</span> <span class="nf">to_excess_returns</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a series of returns, it will return the excess returns over rf.</span>

<span class="sd">    Args:</span>
<span class="sd">        * returns (Series, DataFrame): Returns</span>
<span class="sd">        * rf (float, Series): `Risk-Free rate(s) &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_ expressed in annualized term or return series</span>
<span class="sd">        * nperiods (int): Optional. If provided, will convert rf to different</span>
<span class="sd">            frequency using deannualize only if rf is a float</span>
<span class="sd">    Returns:</span>
<span class="sd">        * excess_returns (Series, DataFrame): Returns - rf</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nperiods</span> <span class="o">=</span> <span class="n">infer_freq</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_rf</span> <span class="o">=</span> <span class="n">deannualize</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_rf</span> <span class="o">=</span> <span class="n">rf</span>

    <span class="k">return</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">_rf</span></div>


<div class="viewcode-block" id="calc_calmar_ratio"><a class="viewcode-back" href="../../ffn.html#ffn.core.calc_calmar_ratio">[docs]</a><span class="k">def</span> <span class="nf">calc_calmar_ratio</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the `Calmar ratio &lt;https://www.investopedia.com/terms/c/calmarratio.asp&gt;`_ given a series of prices</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series, DataFrame): Price series</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">calc_cagr</span><span class="p">(),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">prices</span><span class="o">.</span><span class="n">calc_max_drawdown</span><span class="p">()))</span></div>


<div class="viewcode-block" id="to_ulcer_index"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_ulcer_index">[docs]</a><span class="k">def</span> <span class="nf">to_ulcer_index</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts from prices -&gt; `Ulcer index &lt;https://www.investopedia.com/terms/u/ulcerindex.asp&gt;`_</span>

<span class="sd">    See https://en.wikipedia.org/wiki/Ulcer_index</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series, DataFrame): Prices</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">to_drawdown_series</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">2</span><span class="p">))),</span> <span class="n">dd</span><span class="o">.</span><span class="n">count</span><span class="p">())</span></div>


<div class="viewcode-block" id="to_ulcer_performance_index"><a class="viewcode-back" href="../../ffn.html#ffn.core.to_ulcer_performance_index">[docs]</a><span class="k">def</span> <span class="nf">to_ulcer_performance_index</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts from prices -&gt; `ulcer performance index &lt;https://www.investopedia.com/terms/u/ulcerindex.asp&gt;`_.</span>

<span class="sd">    See https://en.wikipedia.org/wiki/Ulcer_index</span>

<span class="sd">    Args:</span>
<span class="sd">        * prices (Series, DataFrame): Prices</span>
<span class="sd">        * rf (float, Series): `Risk-free rate of return &lt;https://www.investopedia.com/terms/r/risk-freerate.asp&gt;`_. Assumed to be expressed in</span>
<span class="sd">            yearly (annualized) terms or return series</span>
<span class="sd">        * nperiods (int): Used to deannualize rf if rf is provided (non-zero)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nperiods</span> <span class="o">=</span> <span class="n">infer_freq</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rf</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nperiods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;nperiods must be set if rf != 0 and rf is not a price series&quot;</span><span class="p">)</span>

    <span class="n">er</span> <span class="o">=</span> <span class="n">prices</span><span class="o">.</span><span class="n">to_returns</span><span class="p">()</span><span class="o">.</span><span class="n">to_excess_returns</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">nperiods</span><span class="o">=</span><span class="n">nperiods</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">er</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">prices</span><span class="o">.</span><span class="n">to_ulcer_index</span><span class="p">())</span></div>


<div class="viewcode-block" id="resample_returns"><a class="viewcode-back" href="../../ffn.html#ffn.core.resample_returns">[docs]</a><span class="k">def</span> <span class="nf">resample_returns</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample the returns and calculate any statistic on every new sample.</span>

<span class="sd">    https://en.wikipedia.org/wiki/Resampling_(statistics)</span>

<span class="sd">    :param returns (Series, DataFrame): Returns</span>
<span class="sd">    :param func: Given the resampled returns calculate a statistic</span>
<span class="sd">    :param seed: Seed for random number generator</span>
<span class="sd">    :param num_trials: Number of times to resample and run the experiment</span>
<span class="sd">    :return: Series of resampled statistics</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># stats = []</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="ow">is</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;returns needs to be a Series or DataFrame!&quot;</span><span class="p">))</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_trials</span><span class="p">):</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">random_indices</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="extend_pandas"><a class="viewcode-back" href="../../ffn.html#ffn.core.extend_pandas">[docs]</a><span class="k">def</span> <span class="nf">extend_pandas</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extends pandas&#39; PandasObject (Series, Series,</span>
<span class="sd">    DataFrame) with some functions defined in this file.</span>

<span class="sd">    This facilitates common functional composition used in quant</span>
<span class="sd">    finance.</span>

<span class="sd">    Ex:</span>
<span class="sd">        prices.to_returns().dropna().calc_clusters()</span>
<span class="sd">        (where prices would be a DataFrame)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_returns</span> <span class="o">=</span> <span class="n">to_returns</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_log_returns</span> <span class="o">=</span> <span class="n">to_log_returns</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_price_index</span> <span class="o">=</span> <span class="n">to_price_index</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">rebase</span> <span class="o">=</span> <span class="n">rebase</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_perf_stats</span> <span class="o">=</span> <span class="n">calc_perf_stats</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_drawdown_series</span> <span class="o">=</span> <span class="n">to_drawdown_series</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_max_drawdown</span> <span class="o">=</span> <span class="n">calc_max_drawdown</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_cagr</span> <span class="o">=</span> <span class="n">calc_cagr</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_total_return</span> <span class="o">=</span> <span class="n">calc_total_return</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">as_percent</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">as_percent</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">as_format</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">as_format</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_monthly</span> <span class="o">=</span> <span class="n">to_monthly</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">asfreq_actual</span> <span class="o">=</span> <span class="n">asfreq_actual</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">drop_duplicate_cols</span> <span class="o">=</span> <span class="n">drop_duplicate_cols</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_information</span> <span class="o">=</span> <span class="n">calc_information_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_information_ratio</span> <span class="o">=</span> <span class="n">calc_information_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_prob_mom</span> <span class="o">=</span> <span class="n">calc_prob_mom</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_risk_return</span> <span class="o">=</span> <span class="n">calc_risk_return_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_risk_return_ratio</span> <span class="o">=</span> <span class="n">calc_risk_return_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_erc_weights</span> <span class="o">=</span> <span class="n">calc_erc_weights</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_inv_vol_weights</span> <span class="o">=</span> <span class="n">calc_inv_vol_weights</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_mean_var_weights</span> <span class="o">=</span> <span class="n">calc_mean_var_weights</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_clusters</span> <span class="o">=</span> <span class="n">calc_clusters</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_ftca</span> <span class="o">=</span> <span class="n">calc_ftca</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_stats</span> <span class="o">=</span> <span class="n">calc_stats</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">plot_heatmap</span> <span class="o">=</span> <span class="n">plot_heatmap</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">plot_corr_heatmap</span> <span class="o">=</span> <span class="n">plot_corr_heatmap</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">rollapply</span> <span class="o">=</span> <span class="n">rollapply</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">winsorize</span> <span class="o">=</span> <span class="n">winsorize</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">rescale</span> <span class="o">=</span> <span class="n">rescale</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_sortino</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_sortino_ratio</span> <span class="o">=</span> <span class="n">calc_sortino_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_calmar</span> <span class="o">=</span> <span class="n">calc_calmar_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_calmar_ratio</span> <span class="o">=</span> <span class="n">calc_calmar_ratio</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_sharpe</span> <span class="o">=</span> <span class="n">calc_sharpe</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">calc_sharpe_ratio</span> <span class="o">=</span> <span class="n">calc_sharpe</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_excess_returns</span> <span class="o">=</span> <span class="n">to_excess_returns</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_ulcer_index</span> <span class="o">=</span> <span class="n">to_ulcer_index</span>
    <span class="n">PandasObject</span><span class="o">.</span><span class="n">to_ulcer_performance_index</span> <span class="o">=</span> <span class="n">to_ulcer_performance_index</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
        <aside>

            
            <a href="../../index.html" id="logo" title=ffn><img class="logo" src="../../_static/logo.png" width="150px" height="150px" title=ffn /></a>
            
            
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ffn.html">API</a></li>
</ul>


            
            <ul>
                <li><a href="https://github.com/pmorissette/ffn">Github</a></li>
            </ul>
            
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </aside>
    
      <div class="clearer"></div>
    </div>
        <div class="footer">
            ffn was created by Philippe Morissette.
If you find a bug, please <a href="https://github.com/pmorissette/ffn/issues/new" title="Open a new issue on Github">submit an issue</a> on Github.

        </div>

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-52308448-1', 'auto');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
        
  </body>
</html>